# 🛡️ 緊急停止機能の設定ガイド

## 📋 設定項目

`train_unet_split.py` の `CFG` セクションで以下の設定が可能です：

```python
CFG = {
    # ... 他の設定 ...
    
    # メモリ監視・緊急停止
    "ENABLE_EMERGENCY_STOP": True,   # False にすると緊急停止を無効化（警告のみ）
    "EMERGENCY_GPU_THRESHOLD": 0.95,  # GPU使用率の緊急停止閾値 (0.0-1.0)
    "EMERGENCY_RAM_THRESHOLD": 0.90,  # RAM使用率の緊急停止閾値 (0.0-1.0)
}
```

---

## 🎯 使い方

### ケース1: 緊急停止を有効にする（推奨）

```python
"ENABLE_EMERGENCY_STOP": True,
"EMERGENCY_GPU_THRESHOLD": 0.95,  # 95%
"EMERGENCY_RAM_THRESHOLD": 0.90,  # 90%
```

**動作:**
- メモリ使用率が閾値を超えたら自動停止
- モデルを `emergency_epochN.pth` として保存
- PCクラッシュを防ぐ

**おすすめ:**
- ✅ 長時間の学習
- ✅ 大きなバッチサイズ
- ✅ 初めての設定で試す時

---

### ケース2: 緊急停止を無効にする

```python
"ENABLE_EMERGENCY_STOP": False,
```

**動作:**
- メモリ警告は表示されるが停止しない
- クラッシュするまで学習継続
- 自己責任モード

**使用場面:**
- ⚠️ メモリが十分にあることが確認済み
- ⚠️ 閾値を超えても一時的と分かっている
- ⚠️ とにかく最後まで実行したい

---

## ⚙️ 閾値のカスタマイズ

### バッチサイズ別の推奨閾値

| バッチサイズ | 画像サイズ | GPU閾値 | RAM閾値 | 説明 |
|------------|-----------|---------|---------|------|
| 8 | 384×512 | 0.93 | 0.88 | 安全（推奨） ✅ |
| 8 | 512×512 | 0.95 | 0.90 | やや危険（現在設定） |
| 6 | 512×768 | 0.93 | 0.88 | 安全 |
| 4 | 512×768 | 0.90 | 0.85 | とても安全 |

### GPU VRAM別の推奨閾値

| VRAM | GPU閾値 | 説明 |
|------|---------|------|
| 12GB | 0.92-0.95 | ギリギリまで使う |
| 16GB | 0.90-0.93 | 余裕を持つ |
| 24GB | 0.85-0.90 | 安全重視 |

---

## 📊 動作例

### 緊急停止が有効な場合

```
============================================================
🛡️  自動メモリ監視機能 有効
============================================================
緊急停止: ✅ 有効
監視閾値: (512×512, バッチ8用)
  - GPU使用率: 95% で緊急停止
  - RAM使用率: 90% で緊急停止
チェック頻度:
  - Train: 10バッチごと
  - Eval:  15バッチごと
  - エポック開始時: 毎回
緊急停止時の動作:
  - 現在のモデルを emergency_epochN.pth として保存
  - メモリをクリアして安全に終了
============================================================

[Batch 50] ⚠️ GPU使用率が危険: 95.2% (11.42GB/12.0GB)

============================================================
🚨 緊急停止モード
============================================================
理由: ⚠️ GPU使用率が危険: 95.2% (11.42GB/12.0GB)
現在のエポック: 15
✅ 緊急保存完了: emergency_epoch15.pth

安全に終了します...
============================================================
```

### 緊急停止が無効な場合

```
============================================================
🛡️  自動メモリ監視機能 有効
============================================================
緊急停止: ⚠️  無効（警告のみ表示）
  ※ メモリ不足でもPCクラッシュするまで学習継続します
チェック頻度:
  - Train: 10バッチごと
  - Eval:  15バッチごと
  - エポック開始時: 毎回
============================================================

[Batch 50] ⚠️ GPU使用率が危険: 95.2% (11.42GB/12.0GB)
  → 緊急停止は無効化されています（学習継続）

[Batch 60] ⚠️ GPU使用率が危険: 96.1% (11.53GB/12.0GB)
  → 緊急停止は無効化されています（学習継続）

（学習継続...）
```

---

## 🔧 設定変更の手順

### 1. 緊急停止を無効にする

`train_unet_split.py` の21行目付近：

```python
# メモリ監視・緊急停止
"ENABLE_EMERGENCY_STOP": False,   # True → False に変更
```

### 2. 閾値を変更する

```python
# より安全に（早めに停止）
"EMERGENCY_GPU_THRESHOLD": 0.90,  # 95% → 90%
"EMERGENCY_RAM_THRESHOLD": 0.85,  # 90% → 85%

# より攻めに（ギリギリまで使う）
"EMERGENCY_GPU_THRESHOLD": 0.97,  # 95% → 97%
"EMERGENCY_RAM_THRESHOLD": 0.93,  # 90% → 93%
```

---

## 💡 推奨設定パターン

### パターン1: 安全重視（推奨）

```python
"ENABLE_EMERGENCY_STOP": True,
"EMERGENCY_GPU_THRESHOLD": 0.93,
"EMERGENCY_RAM_THRESHOLD": 0.88,
```
- PCクラッシュのリスク最小
- 学習が途中で止まる可能性あり

### パターン2: バランス型（現在）

```python
"ENABLE_EMERGENCY_STOP": True,
"EMERGENCY_GPU_THRESHOLD": 0.95,
"EMERGENCY_RAM_THRESHOLD": 0.90,
```
- クラッシュリスクとパフォーマンスのバランス
- ほとんどの場合で動作する

### パターン3: 攻撃的（上級者向け）

```python
"ENABLE_EMERGENCY_STOP": False,
```
- 最大限のパフォーマンス
- クラッシュリスク高い
- メモリが十分な環境でのみ使用

---

## ⚠️ 注意事項

### 緊急停止を無効にする場合

1. **メモリが十分にあることを確認**
   - GPU VRAM に余裕がある
   - システムRAM に余裕がある

2. **こまめに監視**
   - GPU使用率を nvidia-smi で監視
   - システムが応答しなくなる前に手動停止

3. **こまめにチェックポイント保存**
   - `SAVE_PRED_EVERY` を小さく（例: 5）
   - クラッシュしても損失を最小化

### 閾値を高くしすぎない

```python
# ❌ 危険（おすすめしない）
"EMERGENCY_GPU_THRESHOLD": 0.98,  # 98% は危険！
"EMERGENCY_RAM_THRESHOLD": 0.95,  # 95% は危険！
```

**理由:**
- GPU/RAMが98-99%になるとシステム不安定
- 緊急停止処理自体でメモリ使う可能性
- 他のプロセスの影響で突然上がることも

---

## 🚀 トラブルシューティング

### Q: 緊急停止が頻発する

**A1:** 閾値を少し上げる
```python
"EMERGENCY_GPU_THRESHOLD": 0.95,  # 0.93 → 0.95
```

**A2:** バッチサイズを減らす
```python
"BATCH": 6,  # 8 → 6
```

**A3:** 画像サイズを小さくする
```python
"IMG_SIZE": (384, 512),  # (512, 512) → (384, 512)
```

### Q: 緊急停止を無効にしたのにクラッシュした

**A:** 正常動作です
- 緊急停止無効 = クラッシュまで動く
- メモリ不足は避けられない
- 設定を見直すか緊急停止を有効化

### Q: 閾値を変更したのに反映されない

**A:** スクリプトを再起動
```powershell
# 停止 (Ctrl+C)
# 再実行
python train_unet_split.py
```

---

## 📈 メモリ使用量の目安

### 512×512, バッチ8

| 時点 | GPU使用率 | 予想される状態 |
|------|-----------|---------------|
| 80% | 安全 ✅ | 余裕あり |
| 90% | 注意 ⚠️ | そろそろ限界 |
| 93% | 警告 ⚠️ | 緊急停止推奨 |
| 95% | 危険 🚨 | クラッシュ寸前 |
| 98%+ | クラッシュ 💥 | ほぼ確実にクラッシュ |

---

## 📝 まとめ

### 初心者向け
```python
"ENABLE_EMERGENCY_STOP": True,   # 絶対に有効に！
"EMERGENCY_GPU_THRESHOLD": 0.93,  # 安全な値
"EMERGENCY_RAM_THRESHOLD": 0.88,  # 安全な値
```

### 中級者向け
```python
"ENABLE_EMERGENCY_STOP": True,   # 有効推奨
"EMERGENCY_GPU_THRESHOLD": 0.95,  # やや攻めた値
"EMERGENCY_RAM_THRESHOLD": 0.90,  # やや攻めた値
```

### 上級者向け
```python
# メモリが十分な環境でのみ
"ENABLE_EMERGENCY_STOP": False,  # 自己責任
```

**推奨:** まずは安全設定で試して、問題なければ徐々に攻めていく！
