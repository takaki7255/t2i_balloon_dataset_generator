# ğŸˆ Manga Balloon Generation Project

ãƒãƒ³ã‚¬å¹ãå‡ºã—è‡ªå‹•ç”Ÿæˆãƒ»åˆæˆã‚·ã‚¹ãƒ†ãƒ 

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

### ğŸ¯ ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆ
- `create_syn_dataset.py` - **ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: çµ±è¨ˆæƒ…å ±ãƒ™ãƒ¼ã‚¹ã®é«˜å“è³ªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆ
- `create_syn_dataset_aug.py` - ãƒ‡ãƒ¼ã‚¿æ‹¡å¼µä»˜ããƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆ
- `create_synreal_dataset.py` - åˆæˆ+å®Ÿãƒ‡ãƒ¼ã‚¿ã®çµ±åˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆ
- `create_real_test_datasets.py` - å®Ÿãƒ‡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆ

#### å¹ãå‡ºã—ãƒ»èƒŒæ™¯ç”Ÿæˆ
- `balloon_generate.py` - å¹ãå‡ºã—ç”»åƒç”Ÿæˆ
- `back_generate.py` - èƒŒæ™¯ç”»åƒç”Ÿæˆ
- `balloon_mask.py` - ãƒã‚¹ã‚¯ç”Ÿæˆ

#### åˆæˆã‚·ã‚¹ãƒ†ãƒ 
- `composite_balloons.py` - åŸºæœ¬åˆæˆæ©Ÿèƒ½
- `composite_balloons_optimized.py` - æœ€é©åŒ–ç‰ˆåˆæˆ
- `composite_balloons_crop_optimized.py` - ã‚¯ãƒ­ãƒƒãƒ”ãƒ³ã‚°æœ€é©åŒ–ç‰ˆ
- `generate_random_composite.py` - ãƒ©ãƒ³ãƒ€ãƒ åˆæˆ

#### ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ãƒ»è©•ä¾¡
- `train_unet_balloon.py` - U-Netå­¦ç¿’ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
- `train_unet_split.py` - U-Netãƒ‡ãƒ¼ã‚¿åˆ†å‰²å­¦ç¿’
- `train_deeplabv3_split.py` - **DeepLab v3+å­¦ç¿’**ï¼ˆASPPæ­è¼‰ï¼‰
- `run_deeplabv3_experiments.py` - DeepLab v3+ãƒãƒƒãƒå®Ÿé¨“å®Ÿè¡Œ
- `finetune_unet.py` - ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°
- `test_unet.py` - ãƒ¢ãƒ‡ãƒ«è©•ä¾¡

#### ãƒã‚¹ã‚¯ç”Ÿæˆ
- `generate_all_masks.py` - å¾“æ¥ãƒã‚¹ã‚¯ç”Ÿæˆ
- `generate_all_mask_sam2.py` - SAM2ãƒ™ãƒ¼ã‚¹ãƒã‚¹ã‚¯ç”Ÿæˆ

#### ãã®ä»–
- `seg_balloon_dataset_from_manga109seg.py` - Manga109ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå‡¦ç†
- `split_dataset.py` - ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåˆ†å‰²
- `inpaint_openai.py` - OpenAI inpainting

### ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«ï¼ˆtools/ï¼‰

#### ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ«
- `dataset_quality_analyzer.py` - **ç·åˆå“è³ªåˆ†æãƒ„ãƒ¼ãƒ«**
- `analyze_balloon_scale.py` - å¹ãå‡ºã—ã‚µã‚¤ã‚ºåˆ†æ
- `analyze_new_stats.py` - æ–°è¨­å®šçµ±è¨ˆåˆ†æ
- `analyze_optimization.py` - æœ€é©åŒ–åŠ¹æœåˆ†æ
- `analyze_deeplabv3_architecture.py` - DeepLab v3+ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æ
- `compare_architectures.py` - U-Net vs DeepLab v3+æ¯”è¼ƒ
- `explain_deeplabv3_differences.py` - å­¦ç¿’ã‚¹ã‚¯ãƒªãƒ—ãƒˆå·®åˆ†è§£èª¬

#### ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ãƒ„ãƒ¼ãƒ«
- `test_statistical_sampling.py` - çµ±è¨ˆã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
- `test_crop_comparison.py` - ã‚¯ãƒ­ãƒƒãƒ”ãƒ³ã‚°åŠ¹æœæ¯”è¼ƒ
- `test_scale_sampling.py` - ã‚¹ã‚±ãƒ¼ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
- `check_balloons_size.py` - å¹ãå‡ºã—ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
- `check_alpha.py` - ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«ç¢ºèª

#### è©•ä¾¡ãƒ»æ¯”è¼ƒãƒ„ãƒ¼ãƒ«
- `performance_comparison.py` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ
- `evaluate_current_settings.py` - è¨­å®šè©•ä¾¡

### ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

#### çµ±è¨ˆæƒ…å ±
- `balloon_count_statistics.txt` - **é‡è¦**: å®Ÿãƒ‡ãƒ¼ã‚¿çµ±è¨ˆæƒ…å ±
- `balloon_efficiency_analysis.png` - åŠ¹ç‡åˆ†æçµæœ
- `balloon_size_distribution.png` - ã‚µã‚¤ã‚ºåˆ†å¸ƒã‚°ãƒ©ãƒ•

#### ãƒ¢ãƒ‡ãƒ«
- `sam2.1_hiera_base_plus.pt` - SAM2ãƒ¢ãƒ‡ãƒ«

### ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

#### ç”Ÿæˆãƒ‡ãƒ¼ã‚¿
- `generated_balloons/` - ç”Ÿæˆã•ã‚ŒãŸå¹ãå‡ºã—ç”»åƒ
- `generated_backs/` - ç”Ÿæˆã•ã‚ŒãŸèƒŒæ™¯ç”»åƒ
- `generated_double_backs/` - äºŒé‡èƒŒæ™¯ç”»åƒ
- `masks/` - ãƒã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«

#### ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
- `syn_mihiraki300_dataset/` - **æœ€æ–°ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ**ï¼ˆ300æšï¼‰
- `syn_dataset_aug/` - æ‹¡å¼µãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
- `syn_mihiraki_dataset_aug/` - mihirakiæ‹¡å¼µãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
- `real_dataset/` - å®Ÿãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
- `synthetic_dataset/` - æ—§åˆæˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
- `synthetic_real_dataset/` - åˆæˆ+å®Ÿãƒ‡ãƒ¼ã‚¿çµ±åˆ

#### ãƒ†ã‚¹ãƒˆãƒ»çµæœ
- `test_results/` - ãƒ¢ãƒ‡ãƒ«è©•ä¾¡çµæœ
- `test_image/` - ãƒ†ã‚¹ãƒˆç”»åƒ
- `crop_comparison_test/` - ã‚¯ãƒ­ãƒƒãƒ”ãƒ³ã‚°æ¯”è¼ƒçµæœ
- `real-unet-03/` - å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆ
```bash
python create_syn_dataset.py
```

### 2. ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå“è³ªåˆ†æ
```bash
cd tools
python dataset_quality_analyzer.py
```

### 3. ãƒ¢ãƒ‡ãƒ«å­¦ç¿’

#### U-Netå­¦ç¿’
```bash
python train_unet_split.py
```

#### DeepLab v3+å­¦ç¿’
```bash
# å˜ä¸€å®Ÿé¨“
python train_deeplabv3_split.py

# ãƒãƒƒãƒå®Ÿé¨“ï¼ˆè¤‡æ•°è¨­å®šï¼‰
python run_deeplabv3_experiments.py
```

### 4. ãƒ¢ãƒ‡ãƒ«è©•ä¾¡
```bash
python test_unet.py
```

## ğŸ“ˆ æœ€æ–°ã®æˆæœ

### ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå“è³ªï¼ˆsyn_mihiraki300_datasetï¼‰
- **å¹ãå‡ºã—å€‹æ•°ç²¾åº¦**: å¹³å‡12.40å€‹ vs å®Ÿéš›12.26å€‹ï¼ˆèª¤å·®1.1%ï¼‰
- **ç”»é¢å¹…æ¯”**: 9.9%ï¼ˆé©åˆ‡ãªã‚µã‚¤ã‚ºï¼‰
- **ã‚¯ãƒ­ãƒƒãƒ—åŠ¹ç‡**: 51.1%ï¼ˆå¤§å¹…ãªä½™ç™½å‰Šæ¸›ï¼‰
- **çµ±è¨ˆæº–æ‹ **: å®Ÿéš›ã®ãƒãƒ³ã‚¬åˆ†å¸ƒã«æº–æ‹ 

### ä¸»è¦æ”¹å–„ç‚¹
1. âœ… CFGè¨­å®šå‡ºåŠ›ã®å®Ÿè£…
2. âœ… ã‚¯ãƒ­ãƒƒãƒ”ãƒ³ã‚°æœ€é©åŒ–ï¼ˆä½™ç™½51%å‰Šæ¸›ï¼‰
3. âœ… çµ±è¨ˆæƒ…å ±ãƒ™ãƒ¼ã‚¹ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
4. âœ… è©³ç´°ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 
5. âœ… ã‚µã‚¤ã‚ºæœ€é©åŒ–ï¼ˆ25%â†’10%ï¼‰
6. âœ… åŒ…æ‹¬çš„åˆ†æãƒ„ãƒ¼ãƒ«

## ğŸ”§ è¨­å®š

ä¸»è¦ãªè¨­å®šã¯`create_syn_dataset.py`å†…ã®CFGã§ç®¡ç†ï¼š

```python
CFG = {
    "NUM_BALLOONS_RANGE": (7, 17),      # å®Ÿéš›ã®çµ±è¨ˆã«åˆã‚ã›ãŸç¯„å›²
    "SCALE_MODE": "lognormal",           # çµ±è¨ˆãƒ™ãƒ¼ã‚¹ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
    "SCALE_MEAN": 0.10,                  # èƒŒæ™¯å¹…ã®10%
    "SCALE_CLIP": (0.05, 0.18),          # 5%-18%ã®ç¯„å›²
    "COUNT_STATS_FILE": "balloon_count_statistics.txt"
}
```

## ğŸ“‹ æ³¨æ„äº‹é …

- `tools/`å†…ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹å‰æ
- `syn_mihiraki300_dataset/`ãŒæœ€æ–°ã®é‡è¦ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
- çµ±è¨ˆæƒ…å ±ï¼ˆ`balloon_count_statistics.txt`ï¼‰ã¯å‰Šé™¤å³ç¦
- ç”Ÿæˆãƒ‡ãƒ¼ã‚¿ï¼ˆ`generated_*`ï¼‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯å­¦ç¿’ã«å¿…è¦

## ğŸ† ä»Šå¾Œã®æ‹¡å¼µ

- ã‚ˆã‚Šå¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆ
- è¿½åŠ ã®ãƒ‡ãƒ¼ã‚¿æ‹¡å¼µæ‰‹æ³•
- ã‚ˆã‚Šç²¾å¯†ãªçµ±è¨ˆåˆ†æ
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å“è³ªç›£è¦–

## ğŸ§  ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«

### U-Net
å¾“æ¥ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼ãƒ»ãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼æ§‹é€ ã‚’æŒã¤ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«ã€‚
- ã‚¹ã‚­ãƒƒãƒ—æ¥ç¶šã«ã‚ˆã‚‹é«˜è§£åƒåº¦æƒ…å ±ã®ä¿æŒ
- åŒ»ç™‚ç”»åƒå‡¦ç†ã§å®Ÿç¸¾ã‚ã‚Š
- è»½é‡ã§é«˜é€Ÿãªæ¨è«–

### DeepLab v3+ **ï¼ˆæ–°è¦è¿½åŠ ï¼‰**
Atrous Convolutionã¨ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ«å‡¦ç†ã‚’ç‰¹å¾´ã¨ã™ã‚‹æœ€æ–°ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«ã€‚

#### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
1. **Encoderï¼ˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼ï¼‰**
   - ResNet50/ResNet101ãƒãƒƒã‚¯ãƒœãƒ¼ãƒ³
   - Atrous Convolutionã«ã‚ˆã‚‹å—å®¹é‡æ‹¡å¤§
   - Output Strideè¨­å®šï¼ˆ8ã¾ãŸã¯16ï¼‰

2. **ASPPï¼ˆAtrous Spatial Pyramid Poolingï¼‰**
   - 5ã¤ã®ä¸¦åˆ—ãƒ–ãƒ©ãƒ³ãƒï¼ˆ1Ã—1 conv, 3Ã—3 atrous convÃ—3, Global Average Poolingï¼‰
   - ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ«ç‰¹å¾´æŠ½å‡º
   - Output Stride 16: dilation rates [6,12,18]
   - Output Stride 8: dilation rates [12,24,36]

3. **Decoderï¼ˆãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ï¼‰**
   - ä½ãƒ¬ãƒ™ãƒ«ç‰¹å¾´ã¨ã®èåˆ
   - ãƒã‚¤ãƒªãƒ‹ã‚¢è£œé–“ã«ã‚ˆã‚‹è§£åƒåº¦å¾©å…ƒ
   - è»½é‡ãªè¨­è¨ˆ

#### è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
```python
CFG = {
    "BACKBONE": "resnet50",        # resnet50 or resnet101
    "OUTPUT_STRIDE": 16,           # 8 or 16
    "WANDB_PROJ": "balloon-seg-deeplabv3"
}
```

#### U-Netã¨ã®æ¯”è¼ƒ
| ç‰¹å¾´ | U-Net | DeepLab v3+ |
|------|-------|-------------|
| å—å®¹é‡ | é™å®šçš„ | Atrous Convã§å¤§å¹…æ‹¡å¤§ |
| ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ« | ã‚¹ã‚­ãƒƒãƒ—æ¥ç¶šã®ã¿ | ASPP+ä½ãƒ¬ãƒ™ãƒ«ç‰¹å¾´èåˆ |
| è¨ˆç®—åŠ¹ç‡ | é«˜ã„ | ä¸­ç¨‹åº¦ï¼ˆASPPåˆ†ï¼‰ |
| ç´°éƒ¨ç²¾åº¦ | é«˜ã„ï¼ˆã‚¹ã‚­ãƒƒãƒ—æ¥ç¶šï¼‰ | é«˜ã„ï¼ˆä½ãƒ¬ãƒ™ãƒ«ç‰¹å¾´èåˆï¼‰ |
| å¤§åŸŸçš„ç†è§£ | é™å®šçš„ | å„ªç§€ï¼ˆASPPï¼‰ |

#### å®Ÿé¨“å®Ÿè¡Œ
```bash
# å˜ä¸€è¨­å®šã§ã®å­¦ç¿’
python train_deeplabv3_split.py

# è¤‡æ•°è¨­å®šã§ã®ãƒãƒƒãƒå®Ÿé¨“
python run_deeplabv3_experiments.py

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æ
python analyze_deeplabv3_architecture.py
python compare_architectures.py
```
